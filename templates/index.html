<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DomGen Hosting Service</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f8f9fa; color: #333; }

    header {
      background: #4CAF50; color: white; padding: 15px; text-align: center;
      font-size: 22px; font-weight: bold;
    }

    .container { max-width: 900px; margin: 20px auto; padding: 20px; }

    .card {
      background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    h2 { margin-bottom: 15px; font-size: 20px; color: #4CAF50; }
    input, button, select {
      padding: 10px; margin: 8px 0; width: 100%;
      border: 1px solid #ccc; border-radius: 5px; font-size: 14px;
    }
    button { background: #4CAF50; color: white; cursor: pointer; font-weight: bold; }
    button:hover { background: #45a049; }

    .hidden { display: none; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 5px; }
    .msg.success { background: #d4edda; color: #155724; }
    .msg.error { background: #f8d7da; color: #721c24; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }

    .fixed-footer {
      position: fixed; bottom: 0; width: 100%;
      background: #4CAF50; color: white; text-align: center; padding: 10px;
    }
    .fixed-footer a { color: white; text-decoration: underline; }
  </style>
</head>
<body>
  <header>üåê DomGen Hosting Service</header>

  <div class="container">

    <!-- LOGIN -->
    <div id="login-section" class="card">
      <h2>Login</h2>
      <input type="text" id="login-username" placeholder="Username">
      <input type="password" id="login-password" placeholder="Password">
      <button onclick="login()">Login</button>
      <div id="login-msg" class="msg"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden">
      <div class="card">
        <h2>Welcome, <span id="user-display"></span></h2>
        <p id="uses-info"></p>
      </div>

      <!-- Hosting -->
      <div class="card">
        <h2>Host a Website</h2>
        <form id="upload-form">
          <input type="text" id="site-name" placeholder="Site Name" required>
          <input type="file" id="site-file" accept=".zip">
          <button type="submit">Upload</button>
        </form>
        <textarea id="html-editor" placeholder="Or paste HTML here..." rows="6"></textarea>
        <button onclick="uploadFromText()">Upload from Text</button>
        <div id="upload-msg" class="msg"></div>
      </div>

      <!-- Redeem -->
      <div class="card">
        <h2>Redeem Code</h2>
        <input type="text" id="redeem-code" placeholder="Enter Redeem Code">
        <button onclick="redeemCode()">Redeem</button>
        <div id="redeem-msg" class="msg"></div>
      </div>

      <!-- Admin -->
      <div id="admin-section" class="card hidden">
        <h2>Admin Dashboard</h2>
        
        <h3>Generate Redeem Code</h3>
        <input type="number" id="slots" placeholder="Number of uses for code">
        <button onclick="generateCode()">Generate</button>
        <div id="code-msg" class="msg"></div>

        <h3>All Codes</h3>
        <table id="codes-table">
          <thead><tr><th>Code</th><th>Slots</th><th>Used By</th></tr></thead>
          <tbody></tbody>
        </table>

        <h3>All Users</h3>
        <table id="users-table">
          <thead><tr><th>Username</th><th>Uses Left</th><th>Admin</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="fixed-footer">
    Need help? <a href="https://chat.whatsapp.com/KA28UYJhcCiHneYVHxcCdk" target="_blank">Contact Admin</a>
  </div>

  <script>
    const API = "https://domgen-hosting.onrender.com"; // your backend

    let currentUser = null;
    let isAdmin = false;

    async function login() {
      const username = document.getElementById("login-username").value;
      const password = document.getElementById("login-password").value;

      try {
        const res = await fetch(`${API}/login_user`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (res.ok) {
          currentUser = data.username;
          isAdmin = data.is_admin;
          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("dashboard").classList.remove("hidden");
          document.getElementById("user-display").textContent = currentUser;
          document.getElementById("uses-info").textContent = isAdmin
            ? "You are an Admin. Unlimited hosting."
            : `Uses Left: ${data.uses_left}`;
          if (isAdmin) loadAdminData();
        } else {
          showMsg("login-msg", data.error, true);
        }
      } catch (err) {
        showMsg("login-msg", "Server error", true);
      }
    }

    async function uploadFromText() {
      const htmlContent = document.getElementById("html-editor").value;
      const siteName = document.getElementById("site-name").value;
      if (!htmlContent || !siteName) {
        showMsg("upload-msg", "Enter site name and HTML content.", true);
        return;
      }
      const blob = new Blob([htmlContent], { type: "text/html" });
      const file = new File([blob], "index.html", { type: "text/html" });
      const form = new FormData();
      form.append("username", currentUser);
      form.append("site_name", siteName);

      // Create temporary zip with only index.html
      form.append("file", file);
      try {
        const res = await fetch(`${API}/host_file`, { method: "POST", body: form });
        const data = await res.json();
        if (res.ok) {
          showMsg("upload-msg", `‚úÖ Hosted: <a href="${API}${data.url}" target="_blank">${API}${data.url}</a>. Uses left: ${data.uses_left}`);
        } else {
          showMsg("upload-msg", data.error, true);
        }
      } catch {
        showMsg("upload-msg", "Upload failed", true);
      }
    }

    document.getElementById("upload-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const siteName = document.getElementById("site-name").value;
      const file = document.getElementById("site-file").files[0];
      if (!siteName || !file) {
        showMsg("upload-msg", "Please select site name and file", true);
        return;
      }
      const form = new FormData();
      form.append("username", currentUser);
      form.append("site_name", siteName);
      form.append("file", file);
      try {
        const res = await fetch(`${API}/host_file`, { method: "POST", body: form });
        const data = await res.json();
        if (res.ok) {
          showMsg("upload-msg", `‚úÖ Hosted: <a href="${API}${data.url}" target="_blank">${API}${data.url}</a>. Uses left: ${data.uses_left}`);
        } else {
          showMsg("upload-msg", data.error, true);
        }
      } catch {
        showMsg("upload-msg", "Upload failed", true);
      }
    });

    async function redeemCode() {
      const code = document.getElementById("redeem-code").value;
      try {
        const res = await fetch(`${API}/redeem`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username: currentUser, code })
        });
        const data = await res.json();
        if (res.ok) {
          showMsg("redeem-msg", `Code redeemed. Uses left: ${data.uses_left}`);
          document.getElementById("uses-info").textContent = `Uses Left: ${data.uses_left}`;
        } else {
          showMsg("redeem-msg", data.error, true);
        }
      } catch {
        showMsg("redeem-msg", "Redeem failed", true);
      }
    }

    async function generateCode() {
      const slots = document.getElementById("slots").value;
      try {
        const res = await fetch(`${API}/generate_code`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ slots })
        });
        const data = await res.json();
        if (res.ok) {
          showMsg("code-msg", `New Code: ${data.code} (${data.slots} uses)`);
          loadAdminData();
        } else {
          showMsg("code-msg", data.error, true);
        }
      } catch {
        showMsg("code-msg", "Generation failed", true);
      }
    }

    async function loadAdminData() {
      // codes
      const codesRes = await fetch(`${API}/list_codes`);
      const codes = await codesRes.json();
      const tbody = document.querySelector("#codes-table tbody");
      tbody.innerHTML = "";
      Object.entries(codes).forEach(([code, info]) => {
        tbody.innerHTML += `<tr><td>${code}</td><td>${info.slots}</td><td>${info.used_by.join(", ")}</td></tr>`;
      });

      // users
      const usersRes = await fetch(`${API}/list_users`);
      const users = await usersRes.json();
      const utbody = document.querySelector("#users-table tbody");
      utbody.innerHTML = "";
      Object.entries(users).forEach(([user, info]) => {
        utbody.innerHTML += `<tr><td>${user}</td><td>${info.uses_left}</td><td>${info.is_admin}</td></tr>`;
      });

      document.getElementById("admin-section").classList.remove("hidden");
    }

    function showMsg(id, msg, error=false) {
      const div = document.getElementById(id);
      div.innerHTML = msg;
      div.className = "msg " + (error ? "error" : "success");
    }
  </script>
</body>
</html>
